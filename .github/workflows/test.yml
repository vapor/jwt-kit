name: test
on:
  pull_request:
  push:
    branches:
    - master
jobs:
  dependents:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dependent:
          - jwt
    container: swift:5.7
    steps: 
      - name: Check out JWTKit
        uses: actions/checkout@v3
        with:
          path: jwt-kit
      - name: Check out provider
        uses: actions/checkout@v3
        with:
          repository: vapor/${{ matrix.dependent }}
          path: dependent
      - name: Use local JWTKit
        run: swift package edit jwt-kit --path ../jwt-kit
        working-directory: dependent
      - name: Run tests with Thread Sanitizer
        run: swift test --enable-test-discovery --sanitize=thread
        working-directory: dependent
  unit-tests:
     uses: vapor/ci/.github/workflows/run-unit-tests.yml@reusable-workflows
     with:
       with_coverage: false
       with_tsan: true

  test-exports:
    name: Test exports
    runs-on: ubuntu-latest
    steps:
      - name: Check out source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Build
        run: swift build -Xswiftc -DBUILDING_DOCC
